(function(){var f=YAHOO.util.Dom,j=YAHOO.util.Event,a=YAHOO.util.Selector;var e=Alfresco.util.encodeHTML,i=Alfresco.util.userProfileLink,m=Alfresco.Share.userAvatar;Alfresco.DocumentPublishing=function h(n){Alfresco.DocumentPublishing.superclass.constructor.call(this,"Alfresco.DocumentPublishing",n,["datasource","datatable","paginator","history","animation"]);YAHOO.Bubbling.on("metadataRefresh",this.doRefresh,this);return this};YAHOO.extend(Alfresco.DocumentPublishing,Alfresco.component.Base,{options:{nodeRef:null,siteId:"",containerId:null},onReady:function d(){this.widgets.alfrescoDataTable=new Alfresco.util.DataTable({dataSource:{url:Alfresco.constants.PROXY_URI+"api/publishing/"+this.options.nodeRef.replace("://","/")+"/events",doBeforeParseData:this.bind(function(o,n){n.data.reverse();return n})},dataTable:{container:this.id+"-publishing-events",columnDefinitions:[{key:"publishingEvent",sortable:false,formatter:this.bind(this.renderCellPublishingEvent)}],config:{MSG_EMPTY:this.msg("message.noPublishing")}}})},renderCellPublishingEvent:function g(o,n,p,q){o.innerHTML=this.getDocumentPublishingEventMarkup(n.getData())},getDocumentPublishingEventMarkup:function b(B){var t=this.options.nodeRef,A="",n="",E="",y=Alfresco.util.relativeTime(B.scheduledTime.dateTime),q=Alfresco.constants.URL_RESCONTEXT+"components/document-details/images/status-"+B.status+".png",v="",r=false,u="",z="",o="",D=this.msg("publishingHistory.event.unknownChannel"),p="",s=false;if(B.channel){z=Alfresco.constants.PROXY_URI+B.channel.channelType.icon+"/32";o=B.channel.channelType.title;D=B.channel.title;p=B.channel.id;r=B.channel.channelType.canUnpublish}for(var C=0;C<B.publishNodes.length;C++){A=B.publishNodes[C];if(A.nodeRef===this.options.nodeRef){n=A.name;E=A.version;u="publish";var F=this;(function(){var I=F.widgets.alfrescoDataTable.getDataTable().getRecordSet().getRecords();for(var J=0;J<I.length;J++){var K=I[J].getData().unpublishNodes;for(var H=0;H<K.length;H++){var G=K[H];if(G.nodeRef===A.nodeRef&&G.version===A.version){s=true;return}}}})();break}}if(n===""){for(var C=0;C<B.unpublishNodes.length;C++){A=B.unpublishNodes[C];if(A.nodeRef===this.options.nodeRef){n=A.name;E=A.version;u="unpublish";break}}}var x=this.msg("publishingHistory.status."+u+"."+B.status),w=this.msg("publishingHistory.status.display",x,y);if(n!==""){v+='<div class="publishing-panel-left">';v+='   <span class="document-version">'+e(E)+"</span>";v+="</div>";v+='<div class="publishing-panel-right">';v+='   <h3 class="thin dark">'+e(n)+"</h3>";v+='   <span class="actions">';if(r&&B.status==="COMPLETED"&&u==="publish"&&!s){v+='		<a href="#" name=".onUnpublishClick" rel="'+t+'" class="'+this.id+' unpublish" title="'+this.msg("publishingHistory.action.unpublish")+'">&nbsp;</a>'}v+="   </span>";v+='   <div class="clear"></div>';v+='   <div class="channel-details">';if(z!==""){v+='   <img src="'+e(z)+'" alt="'+e(o)+'" title="'+e(o)+'"/>'}v+='      <span class="channel-name">'+e(D)+"<span>";v+="   </div>";v+='   <div class="status-details">';v+='      <img src="'+e(q)+'" alt="'+e(x)+'" title="'+e(x)+'"/><span class="status">'+w+"<span>";v+="   </div>";v+="</div>";v+='<div class="clear"></div>'}return v},onUnpublishClick:function c(o,n){var p=this,q=this.widgets.alfrescoDataTable.widgets.dataTable.getRecord(n).getData().channel.id;Alfresco.util.PopupManager.displayPrompt({title:p.msg("publishingHistory.unpublish.title"),text:p.msg("publishingHistory.unpublish.confirm"),buttons:[{text:p.msg("button.ok"),handler:function(){this.destroy();var r=Alfresco.constants.PROXY_URI+"/api/publishing/queue";Alfresco.util.Ajax.request({url:r,method:Alfresco.util.Ajax.POST,requestContentType:"application/json",responseContentType:"application/json",dataObj:{channelId:q,unpublishNodes:[o]},successCallback:{fn:p.onUnpublishSuccess,scope:p},failureCallback:{fn:function s(t){Alfresco.util.PopupManager.displayPrompt({text:p.msg("publishingHistory.unpublish.failure")})},scope:p}})}},{text:p.msg("button.cancel"),handler:function(){this.destroy()},isDefault:true}]})},onUnpublishSuccess:function l(n){Alfresco.util.PopupManager.displayMessage({text:this.msg("publishingHistory.unpublish.success")});this.doRefresh()},doRefresh:function k(){var n=this.widgets.alfrescoDataTable.widgets.dataTable;n.getDataSource().sendRequest("",{success:n.onDataReturnInitializeTable,scope:n})}})})();